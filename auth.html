<!DOCTYPE html>
<html>
<head>
    <title>Spotify Auth Callback</title>
    <style>
        body {
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .status-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 20px auto;
        }
        #debug-console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            text-align: left;
            font-family: monospace;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="status-box">
        <h2 id="status-title">🔄 授权处理中...</h2>
        <div id="status-detail"></div>
        <button onclick="window.close()" style="margin-top:15px;">手动关闭窗口</button>
    </div>

    <script>
    // 调试模式控制
    const DEBUG_MODE = location.hash.includes('debug');
    let operationLog = [];

    function updateStatus(message, isError = false) {
        document.getElementById('status-title').innerHTML = message;
        if (isError) {
            document.getElementById('status-title').style.color = '#ff4444';
        }
    }

    function logDetail(message) {
        operationLog.push(message);
        if (DEBUG_MODE) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        console.log('[Auth Debug]', message);
    }

    function sendAuthMessage() {
        try {
            // 验证父窗口
            if (!window.opener || window.opener.closed) {
                throw new Error('父窗口不存在或已关闭');
            }

            // 动态验证域名
            const validOrigins = [
                'https://live.bilibili.com',
                'https://www.bilibili.com'
            ];

            const targetOrigin = validOrigins.find(origin => {
                try {
                    return window.opener.location.href.startsWith(origin);
                } catch (e) {
                    logDetail(`安全策略阻止源检测: ${e.message}`);
                    return false;
                }
            });

            if (!targetOrigin) {
                throw new Error('域名不匹配，有效域名为: ' + validOrigins.join(', '));
            }

            // 处理参数
            const params = new URLSearchParams(location.search);
            const code = params.get('code');
            const error = params.get('error');

            // 构建消息
            const message = {
                type: code ? 'spotify_code' : 'auth_error',
                code: code,
                error: error,
                _signature: `bili_${Date.now()}`
            };

            // 发送消息
            logDetail(`正在向 ${targetOrigin} 发送消息...`);
            window.opener.postMessage(message, targetOrigin);
            logDetail('消息发送成功');

            // 自动关闭机制
            setTimeout(() => {
                logDetail('执行自动关闭');
                window.close();
            }, 800);

        } catch (error) {
            updateStatus(`❌ ${error.message}`, true);
            document.getElementById('status-detail').innerHTML = `
                <div style="text-align:left;margin-top:15px;">
                    <p>技术详情：</p>
                    <ul>
                        <li>错误类型：${error.name}</li>
                        <li>当前域名：${location.hostname}</li>
                        <li>父窗口状态：${window.opener ? '存在' : '不存在'}</li>
                    </ul>
                </div>
            `;
        }
    }

    // 启动流程
    setTimeout(sendAuthMessage, 300);
    </script>
</body>
</html>
