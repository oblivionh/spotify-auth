<!DOCTYPE html>
<html>
<head>
    <title>Spotify Auth Callback</title>
    <style>
        body {
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .status-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 20px auto;
        }
        #debug-console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            text-align: left;
            font-family: monospace;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="status-box">
        <h2 id="status-title">ğŸ”„ æˆæƒå¤„ç†ä¸­...</h2>
        <div id="status-detail"></div>
        <button onclick="window.close()" style="margin-top:15px;">æ‰‹åŠ¨å…³é—­çª—å£</button>
    </div>

    <script>
    // è°ƒè¯•æ¨¡å¼æ§åˆ¶
    const DEBUG_MODE = location.hash.includes('debug');
    let operationLog = [];

    function updateStatus(message, isError = false) {
        document.getElementById('status-title').innerHTML = message;
        if (isError) {
            document.getElementById('status-title').style.color = '#ff4444';
        }
    }

    function logDetail(message) {
        operationLog.push(message);
        if (DEBUG_MODE) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        console.log('[Auth Debug]', message);
    }

    function sendAuthMessage() {
        try {
            // éªŒè¯çˆ¶çª—å£
            if (!window.opener || window.opener.closed) {
                throw new Error('çˆ¶çª—å£ä¸å­˜åœ¨æˆ–å·²å…³é—­');
            }

            // åŠ¨æ€éªŒè¯åŸŸå
            const validOrigins = [
                'https://live.bilibili.com',
                'https://www.bilibili.com'
            ];

            const targetOrigin = validOrigins.find(origin => {
                try {
                    return window.opener.location.href.startsWith(origin);
                } catch (e) {
                    logDetail(`å®‰å…¨ç­–ç•¥é˜»æ­¢æºæ£€æµ‹: ${e.message}`);
                    return false;
                }
            });

            if (!targetOrigin) {
                throw new Error('åŸŸåä¸åŒ¹é…ï¼Œæœ‰æ•ˆåŸŸåä¸º: ' + validOrigins.join(', '));
            }

            // å¤„ç†å‚æ•°
            const params = new URLSearchParams(location.search);
            const code = params.get('code');
            const error = params.get('error');

            // æ„å»ºæ¶ˆæ¯
            const message = {
                type: code ? 'spotify_code' : 'auth_error',
                code: code,
                error: error,
                _signature: `bili_${Date.now()}`
            };

            // å‘é€æ¶ˆæ¯
            logDetail(`æ­£åœ¨å‘ ${targetOrigin} å‘é€æ¶ˆæ¯...`);
            window.opener.postMessage(message, targetOrigin);
            logDetail('æ¶ˆæ¯å‘é€æˆåŠŸ');

            // è‡ªåŠ¨å…³é—­æœºåˆ¶
            setTimeout(() => {
                logDetail('æ‰§è¡Œè‡ªåŠ¨å…³é—­');
                window.close();
            }, 800);

        } catch (error) {
            updateStatus(`âŒ ${error.message}`, true);
            document.getElementById('status-detail').innerHTML = `
                <div style="text-align:left;margin-top:15px;">
                    <p>æŠ€æœ¯è¯¦æƒ…ï¼š</p>
                    <ul>
                        <li>é”™è¯¯ç±»å‹ï¼š${error.name}</li>
                        <li>å½“å‰åŸŸåï¼š${location.hostname}</li>
                        <li>çˆ¶çª—å£çŠ¶æ€ï¼š${window.opener ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</li>
                    </ul>
                </div>
            `;
        }
    }

    // å¯åŠ¨æµç¨‹
    setTimeout(sendAuthMessage, 300);
    </script>
</body>
</html>
